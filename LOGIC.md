# Casino 777 - Документация логики

Дата: 2026-02-06

## Цель
Веб-приложение для запуска локально или на сервере. Имитация игрового автомата с заранее заданными комбинациями. Выпадения чередуются честно, а история/настройки сохраняются на сервере и доступны после перезагрузки.

## Основной функционал

### 0) Вкладки табло
- В табло есть 2 вкладки:
  - `Правила`
  - `Комбинации`
- Переключение вкладок расположено внизу табло.
- Во вкладке `Правила` отображаются правила проведения.
- Во вкладке `Комбинации` отображается список комбинаций и блок управления пулом.

### 1) Спины (Spin)
- Кнопка: `SPIN`
- Результат всегда выбирается из пула заранее заданных комбинаций.
- Если в пуле больше одной комбинации, **одна и та же комбинация не может выпасть два раза подряд**.
- Счетчик спинов увеличивается на 1.
- Выпавшая комбинация подсвечивается на табло.
- После завершения прокрутки открывается `JACKPOT`-окно с:
  - выпавшей комбинацией
  - именем победителя, присвоенным этой комбинации
- `JACKPOT`-окно закрывается вручную (кнопка `Закрыть` или клик по фону).

### 2) Баланс выпадений
- У каждой комбинации есть счетчик `hits` — сколько раз она выпадала.
- При выборе комбинации берутся только те, у которых **минимальный `hits`**.
- Если предыдущая комбинация совпадает с текущей, она исключается из выбора (если есть альтернативы).
- Из кандидатов выбирается случайная комбинация.

### 3) Победитель
- Имя победителя хранится у каждой комбинации.
- Имя можно редактировать вручную прямо в табло.
- При выпадении комбинации в попапе показывается текущее имя, присвоенное этой комбинации.

### 4) Управление пулом
- Добавление новой комбинации через поле "Новая комбинация".
- Удаление комбинации через поле "Удалить комбинацию".
- Перемешивание пула (`Перемешать пул`) меняет порядок карточек на табло.
- В табло у каждой комбинации есть переключатель `ON/OFF`:
  - `OFF`: комбинация остается в списке, но не участвует в выпадениях.
  - `ON`: комбинация снова может выпадать.

### 5) Сбросы
- `Сбросить статистику`: обнуляет `hits`, историю последнего выпадения и счетчик спинов.
- `Сбросить к дефолту`: возвращает исходные 10 комбинаций и обнуляет спины.

### 6) Серверное хранение
- Данные хранятся на сервере в `data/state.json`:
  - комбинации (включая `hits`, `enabled`, `winner`)
  - история спинов
  - последняя выпавшая комбинация
  - настройки (фон, звуки, громкости, скорость, loop)
- UI общается с сервером по API (`/api/...`).

### 7) Пользовательский фон
- Кнопка `Загрузить фон` открывает выбор файла изображения.
- Выбранный фон применяется ко всей странице и сохраняется на сервере.
- Кнопка `Удалить фон` очищает пользовательский фон и возвращает стандартный.

### 8) Скорость барабанов
- Внизу страницы есть слайдер `Скорость прокрутки (мс)`.
- Меньшее значение = более быстрая смена символов во время спина.
- Значение сохраняется на сервере и применяется при следующем запуске.

### 9) Аудио-настройки
- Внизу страницы есть 3 отдельных источника звука:
  - фоновая музыка
  - звук прокрутки автомата
  - звук джекпота
- Каждый звук можно:
  - загрузить своим файлом
  - удалить
  - отрегулировать по громкости (0-100%)
- Для звука джекпота есть переключатель `Зациклить звук выигрыша`.
- Все 3 файла и их громкость сохраняются на сервере и восстанавливаются после перезагрузки.
- Логика воспроизведения:
  - фоновая музыка играет в цикле
  - звук прокрутки стартует при запуске спина и останавливается после завершения
  - звук джекпота включается при показе `JACKPOT`-окна

## Алгоритм выбора комбинации

Псевдокод:

```
activePool = pool where enabled == true
if activePool.length == 0: return null
if activePool.length == 1: return activePool[0]

poolExcludingLast = activePool without lastCombo
poolToUse = poolExcludingLast if not empty else activePool

minHits = min(poolToUse.hits)
candidates = poolToUse where hits == minHits
winner = random(candidates)
```

После выбора:
- `winner.hits += 1`
- `lastCombo = winner.combo`
- `spinCount += 1`

## Тестовые сценарии

### A. Никаких повторов подряд
1. Убедиться, что в пуле >= 2 комбинаций
2. Нажимать `SPIN` несколько раз
3. Одна и та же комбинация не должна идти подряд

### B. Выравнивание выпадений
1. Сбросить статистику
2. Сделать 100+ спинов
3. Убедиться, что разница между количеством выпадений у комбинаций минимальна (обычно 0 или 1)

### C. Запись победителя
1. Ввести имя в поле `Имя победителя`
2. Нажать `SPIN`
3. Убедиться, что имя записалось к выпавшей комбинации

### D. Сброс статистики
1. Сделать несколько спинов
2. Нажать `Сбросить статистику`
3. Убедиться, что `hits` и счетчик спинов сброшены

### E. Управление пулом
1. Добавить новую комбинацию
2. Убедиться, что она появилась на табло
3. Удалить ее через поле удаления
4. Убедиться, что она исчезла

### F. Фон страницы
1. Нажать `Загрузить фон` и выбрать изображение
2. Убедиться, что фон страницы изменился
3. Перезагрузить страницу и убедиться, что фон сохранился
4. Нажать `Удалить фон` и убедиться, что вернулся стандартный фон

### G. Скорость прокрутки
1. Изменить слайдер `Скорость прокрутки (мс)`
2. Запустить `SPIN`
3. Убедиться, что скорость смены символов изменилась
4. Перезагрузить страницу и убедиться, что значение сохранено

### H. Аудио
1. Загрузить по одному аудиофайлу для фона/прокрутки/джекпота
2. Настроить громкость каждого файла слайдерами
3. Перезагрузить страницу и проверить, что файлы и громкости восстановились
4. Проверить воспроизведение:
   - фон играет в цикле
   - звук прокрутки играет только во время спина
   - звук джекпота играет при показе попапа

## Файлы
- `index.html` — разметка
- `style.css` — стили
- `app.js` — логика
- `LOGIC.md` — эта документация
